<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SHE学习笔记 | fineのblog</title><meta name="author" content="fine"><meta name="copyright" content="fine"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f5f0fa"><meta name="description" content="初探SEH,仅仅是入门~ # 简介and闲话 作为一个根本没有接触过SEH的人，上来就做相关题目，不出所料被暴打了呜呜~~ 不过初次接触很多新的概念是会感觉陌生和难以理解，翻来覆去多看几遍，对照着题目练习，慢慢就能接受了 用两天时间也就差不多可以大致了解一些相关的异常处理了 至于不过这篇文章只是一些比较简单的应用，而且只涉及了SEH，（因为我太菜了，动调也是ida，主要是不太会用OD和X6">
<meta property="og:type" content="article">
<meta property="og:title" content="SHE学习笔记">
<meta property="og:url" content="http://zz-906.github.io/2024/11/16/SHE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="fineのblog">
<meta property="og:description" content="初探SEH,仅仅是入门~ # 简介and闲话 作为一个根本没有接触过SEH的人，上来就做相关题目，不出所料被暴打了呜呜~~ 不过初次接触很多新的概念是会感觉陌生和难以理解，翻来覆去多看几遍，对照着题目练习，慢慢就能接受了 用两天时间也就差不多可以大致了解一些相关的异常处理了 至于不过这篇文章只是一些比较简单的应用，而且只涉及了SEH，（因为我太菜了，动调也是ida，主要是不太会用OD和X6">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://zz-906.github.io/img/02.png">
<meta property="article:published_time" content="2024-11-16T05:43:35.000Z">
<meta property="article:modified_time" content="2025-08-12T14:20:29.643Z">
<meta property="article:author" content="fine">
<meta property="article:tag" content="RE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://zz-906.github.io/img/02.png"><link rel="shortcut icon" href="/img/hutao.png"><link rel="canonical" href="http://zz-906.github.io/2024/11/16/SHE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#2d0a3d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f5f0fa')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Chewy&amp;family=Ma+Shan+Zheng&amp;family=Fredoka+One&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":"ture","top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"本文最后更新于","messageNext":"天前，部分内容可能已失效"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":300,"languages":{"author":"作者: fine","link":"链接: ","source":"来源: fineのblog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SHE学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-12 22:20:29'
}</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Chewy&family=Fredoka+One&family=Caveat:wght@400;700&family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@300;500;700&display=swap" rel="stylesheet"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/categorybar.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/hutao.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null;src='/img/hutao.png'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/02.png);"><nav id="nav"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/logo.png" alt="Logo"><span class="site-name">fineのblog</span></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SHE学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-16T05:43:35.000Z" title="发表于 2024-11-16 13:43:35">2024-11-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-12T14:20:29.643Z" title="更新于 2025-08-12 22:20:29">2025-08-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>初探SEH,仅仅是入门~ # 简介and闲话
作为一个根本没有接触过SEH的人，上来就做相关题目，不出所料被暴打了呜呜~~
不过初次接触很多新的概念是会感觉陌生和难以理解，翻来覆去多看几遍，对照着题目练习，慢慢就能接受了
用两天时间也就差不多可以大致了解一些相关的异常处理了
至于不过这篇文章只是一些比较简单的应用，而且只涉及了SEH，（因为我太菜了，动调也是ida，主要是不太会用OD和X64..）
对于VEH、UEH、VCH等异常处理还没有研究过，SEH栈展开之类的高级内容也许以后学了会再写一篇
## 下面介绍一下SEH: <strong>功能</strong>
SEH实际包含两个主要功能：结束处理（termination
handling）和异常处理(exception handling)
每当你建立一个try块，它必须跟随一个finally块或一个except块。
一个try块之后不能既有finally块又有except块。但可以在try-except块中嵌套try-finally块，反过来
也可以。 __try,__finally关键字用来标出结束处理程序两段代码的轮廓
不管保护体（try块）
是如何退出的。不论你在保护体中使用return，还是goto，或者是longjump，结束处理程序
（finally块）都将被调用。 在try使用__leave关键字会引起跳转到try块的结尾
TIB结构:在用户模式下，TIB(ThreadInformationBlock)位于TEB的头部。而TEB是操作系统为了保存每个线程的私有数据创建的，每个线程都有自己的TEB。（这个没有理解也没关系，下面我详细说一下）
画一个流程图也许会更好理解 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">+---------+    +----------------+      +---------------+</span><br><span class="line">| 发生异常 +---&gt;+   TIB          +-----&gt;+   Next        +--+</span><br><span class="line">|         |    |   fs:[0]       |      +---------------+  |            +------------------+</span><br><span class="line">+---------+    +----------------+      |   Handler     +--------------&gt;+  异常处理函数     |</span><br><span class="line">                                       +---------------+  |            |  ...             |</span><br><span class="line">                                                          |            |  retn            |</span><br><span class="line">                                               +----------+            +------------------+</span><br><span class="line">                                               |</span><br><span class="line">                                       +-------v-------+</span><br><span class="line">                                       |   Next        +--+</span><br><span class="line">                                       +---------------+  |            +------------------+</span><br><span class="line">                                       |   Handler     +--------------&gt;+  异常处理函数     |</span><br><span class="line">                                       +---------------+  |            |  ...             |</span><br><span class="line">                                                          |            |  retn            |</span><br><span class="line">                                               +----------+            +------------------+</span><br><span class="line">                                               |</span><br><span class="line">                                       +-------v-------+</span><br><span class="line">                                       |  FFFFFFh      |</span><br><span class="line">                                       +---------------+               +------------------+</span><br><span class="line">                                       |   Handler     +--------------&gt;+  异常处理函数     |</span><br><span class="line">                                       +---------------+               |  ...             |</span><br><span class="line">                                                                       |  retn            |</span><br><span class="line">                                                                       +------------------+</span><br></pre></td></tr></table></figure></p>
<p>next是下一个链的地址。如果next的值是FFFFFFh,表示是链表的最后一个节点，该节点的回调函数是系统设置的一个终结处理函数，所有无人值守的异常都会到达这里。
异常处理函数可以是自定义的函数，系统有一个默认的函数，但我们可以自定义一个异常处理函数，让它来处理。
但是得先安装自定义函数才能使用。 下面看一个小例子，虽然不是我自己写的
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">基本结构</span><br><span class="line">__try &#123;</span><br><span class="line">        // 受保护的代码</span><br><span class="line">&#125;</span><br><span class="line">__except ( /*异常过滤器exception filter*/ ) &#123;</span><br><span class="line">        // 异常处理程序exception handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> __try:
__try块中包含可能触发异常的代码。如果代码抛出异常，则交由__except块处理。</p>
<p>__except: __except块中是用户定义的处理异常的代码。</p>
<p>exception filter: exception
filter称为异常过滤器。顾名思义，它的作用是对异常进行过滤。</p>
<p>异常过滤器只有三个值（定义在Windows的Excpt.h中）：
EXCEPTION_CONTINUE_EXECUTION（-1） 在发生异常的地方继续执行。
EXCEPTION_CONTINUE_SEARCH （0） 异常无法识别。继续搜索下一个处理程序。
EXCEPTION_EXECUTE_HANDLER （1）
异常被识别。通过执行控制转移到异常处理程序__except复合语句，然后继续执行__except块。
异常过滤器决定了是否处理当前异常，即是否执行__except块中的代码（异常处理程序exception
handler）。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* mem = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Hello World!\n&quot;</span>;</span><br><span class="line">    __try &#123;</span><br><span class="line">        *mem = <span class="number">0</span>; <span class="comment">//throw exception</span></span><br><span class="line">    &#125;</span><br><span class="line">    __except (exception_memory_access_violation(GetExceptionInformation()))  <span class="comment">//handler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Memory error in except&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">exception_memory_access_violation</span><span class="params">(LPEXCEPTION_POINTERS p_exinfo)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (p_exinfo-&gt;ExceptionRecord-&gt;ExceptionCode == EXCEPTION_ACCESS_VIOLATION)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>  EXCEPTION_EXECUTE_HANDLER; <span class="comment">//handle this exception</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH; <span class="comment">//Do not handle this exception</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
对于这段代码而言，在异常过滤器中自定义了一个函数exception_memory_access_violation，
以GetExceptionInformation()的返回值作为参数，返回值是一个异常过滤器的值，所以也可以直接在__except块的参数中写入异常过滤器的值，如__except
(EXCEPTION_EXECUTE_HANDLER) 。
具体而言，GetExceptionInformation()函数返回__try块中产生的异常值（也就是产生异常的原因），据此我们可以实现对异常的过滤。
下面看一些操作系统的异常值： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_ACCESS_VIOLATION         0xC0000005     </span><br><span class="line">程序企图读写一个不可访问的地址时引发的异常。例如企图读取0地址处的内存。</span><br><span class="line">EXCEPTION_ARRAY_BOUNDS_EXCEEDED    0xC000008C     </span><br><span class="line">数组访问越界时引发的异常。</span><br><span class="line">EXCEPTION_BREAKPOINT               0x80000003     </span><br><span class="line">触发断点时引发的异常。</span><br><span class="line">EXCEPTION_DATATYPE_MISALIGNMENT    0x80000002     </span><br><span class="line">程序读取一个未经对齐的数据时引发的异常。</span><br><span class="line">EXCEPTION_FLT_DENORMAL_OPERAND     0xC000008D     </span><br><span class="line">如果浮点数操作的操作数是非正常的，则引发该异常。所谓非正常，即它的值太小以至于不能用标准格式表示出来。</span><br><span class="line">EXCEPTION_FLT_DIVIDE_BY_ZERO       0xC000008E     </span><br><span class="line">浮点数除法的除数是0时引发该异常。</span><br><span class="line">EXCEPTION_FLT_INEXACT_RESULT       0xC000008F     </span><br><span class="line">浮点数操作的结果不能精确表示成小数时引发该异常。</span><br><span class="line">EXCEPTION_FLT_INVALID_OPERATION    0xC0000090     </span><br><span class="line">该异常表示不包括在这个表内的其它浮点数异常。</span><br><span class="line">EXCEPTION_FLT_OVERFLOW             0xC0000091     </span><br><span class="line">浮点数的指数超过所能表示的最大值时引发该异常。</span><br><span class="line">EXCEPTION_FLT_STACK_CHECK          0xC0000092     </span><br><span class="line">进行浮点数运算时栈发生溢出或下溢时引发该异常。</span><br><span class="line">EXCEPTION_FLT_UNDERFLOW            0xC0000093     </span><br><span class="line">浮点数的指数小于所能表示的最小值时引发该异常。</span><br><span class="line">EXCEPTION_ILLEGAL_INSTRUCTION      0xC000001D     </span><br><span class="line">程序企图执行一个无效的指令时引发该异常。</span><br><span class="line">EXCEPTION_IN_PAGE_ERROR            0xC0000006     </span><br><span class="line">程序要访问的内存页不在物理内存中时引发的异常。</span><br><span class="line">EXCEPTION_INT_DIVIDE_BY_ZERO       0xC0000094     </span><br><span class="line">整数除法的除数是0时引发该异常。</span><br><span class="line">EXCEPTION_INT_OVERFLOW             0xC0000095     </span><br><span class="line">整数操作的结果溢出时引发该异常。</span><br><span class="line">EXCEPTION_INVALID_DISPOSITION      0xC0000026     </span><br><span class="line">异常处理器返回一个无效的处理的时引发该异常。</span><br><span class="line">EXCEPTION_NONCONTINUABLE_EXCEPTION 0xC0000025     </span><br><span class="line">发生一个不可继续执行的异常时，如果程序继续执行，则会引发该异常。</span><br><span class="line">EXCEPTION_PRIV_INSTRUCTION         0xC0000096     </span><br><span class="line">程序企图执行一条当前CPU模式不允许的指令时引发该异常。</span><br><span class="line">EXCEPTION_SINGLE_STEP              0x80000004     </span><br><span class="line">标志寄存器的TF位为1时，每执行一条指令就会引发该异常。主要用于单步调试。</span><br><span class="line">EXCEPTION_STACK_OVERFLOW           0xC00000FD     </span><br><span class="line">栈溢出时引发该异常。</span><br></pre></td></tr></table></figure> 也可以从ida里面看到</p>
<figure>
<img src="/images/SEH1.png" alt="SEH" />
<figcaption aria-hidden="true">SEH</figcaption>
</figure>
<p>举例来讲，如果__try块中产生整数除零异常，那么GetExceptionInformation()函数返回0xC0000094自定义过滤器中将这个值与预先设定好的异常值比较。
在此例中，这个异常值是EXCEPTION_ACCESS_VIOLATION，即0xC0000005。如果异常值相等，那么就返回EXCEPTION_EXECUTE_HANDLER，进而执行exception
handler，也就是使用当前__except块处理异常，否则就返回EXCEPTION_CONTINUE_SEARCH，即继续搜索下一个异常处理程序。
所以，只有__try块中产生读写不可访问地址异常时，__except块才会处理该异常。也就是说，除了EXCEPTION_ACCESS_VIOLATION这个异常，__except都不会处理。
也就是说，__try块中产生整数除零异常并不会触发异常处理
下面，我用几道题来具体说明一下： # moectf2022 Fake_code
点进去很容易可以看见主逻辑，但是你这样解密之后，就会发现粗来一堆乱码~~</p>
<figure>
<img src="/images/SEH2.png" alt="Fake_code" />
<figcaption aria-hidden="true">Fake_code</figcaption>
</figure>
<p>然后肯定感觉到出题人包藏东西了，动调会发现不断地报异常，SEH无疑了</p>
<p>查看汇编，可以发现</p>
<figure>
<img src="/images/SEH3.png" alt="Fake_code" />
<figcaption aria-hidden="true">Fake_code</figcaption>
</figure>
<p>如果你有一点点汇编基础，就可以知道，如果这是一个正数，__try块中就会触发除0异常，进入__except块处理该异常，由于ida不能反编译这一块的内容，我们只能硬读汇编，<sub>由于这不是我们这篇文章的重点，简要略过简要略过</sub></p>
<figure>
<img src="/images/SEH4.png" alt="Fake_code" />
<figcaption aria-hidden="true">Fake_code</figcaption>
</figure>
<p>except块中对应的代码即key = (97 * key + 101) % 233; key ^= 0x29;
loc_140001212即input[i] ^= box[key];</p>
<p>main函数已经编译出来，这样就可以写代码了 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">enc = [<span class="number">30</span>,<span class="number">112</span>,<span class="number">122</span>,<span class="number">110</span>,<span class="number">234</span>,<span class="number">131</span>,<span class="number">158</span>,<span class="number">239</span>,<span class="number">150</span>,<span class="number">226</span>,<span class="number">178</span>,<span class="number">213</span>,<span class="number">153</span>,<span class="number">187</span>,<span class="number">187</span>,<span class="number">120</span>,<span class="number">185</span>,<span class="number">61</span>,<span class="number">110</span>,<span class="number">56</span>,<span class="number">66</span>,<span class="number">194</span>,<span class="number">134</span>,<span class="number">255</span>,<span class="number">99</span>,<span class="number">189</span>,<span class="number">250</span>,<span class="number">121</span>,<span class="number">163</span>,<span class="number">109</span>,<span class="number">96</span>,<span class="number">148</span>,<span class="number">179</span>,<span class="number">66</span>,<span class="number">17</span>,<span class="number">195</span>,<span class="number">144</span>,<span class="number">137</span>,<span class="number">189</span>,<span class="number">239</span>,<span class="number">212</span>,<span class="number">151</span>,<span class="number">248</span>,<span class="number">123</span>,<span class="number">139</span>,<span class="number">11</span>,<span class="number">45</span>,<span class="number">117</span>,<span class="number">126</span>,<span class="number">221</span>,<span class="number">203</span>]</span><br><span class="line">box = [<span class="number">172</span>, <span class="number">4</span>, <span class="number">88</span>, <span class="number">176</span>, <span class="number">69</span>, <span class="number">150</span>, <span class="number">159</span>, <span class="number">46</span>, <span class="number">65</span>, <span class="number">21</span>, <span class="number">24</span>, <span class="number">41</span>, <span class="number">177</span>, <span class="number">51</span>, <span class="number">170</span>, <span class="number">18</span>, <span class="number">13</span>, <span class="number">137</span>, <span class="number">230</span>, <span class="number">250</span>, <span class="number">243</span>, <span class="number">196</span>, <span class="number">189</span>, <span class="number">231</span>, <span class="number">112</span>, <span class="number">138</span>, <span class="number">148</span>, <span class="number">193</span>, <span class="number">133</span>, <span class="number">157</span>, <span class="number">163</span>, <span class="number">242</span>, <span class="number">63</span>, <span class="number">130</span>, <span class="number">142</span>, <span class="number">215</span>, <span class="number">3</span>, <span class="number">147</span>, <span class="number">61</span>, <span class="number">19</span>, <span class="number">5</span>, <span class="number">107</span>, <span class="number">65</span>, <span class="number">3</span>, <span class="number">150</span>, <span class="number">118</span>, <span class="number">227</span>, <span class="number">177</span>, <span class="number">138</span>, <span class="number">74</span>, <span class="number">34</span>, <span class="number">85</span>, <span class="number">196</span>, <span class="number">25</span>, <span class="number">245</span>, <span class="number">85</span>, <span class="number">166</span>, <span class="number">31</span>, <span class="number">14</span>, <span class="number">97</span>, <span class="number">39</span>, <span class="number">203</span>, <span class="number">31</span>, <span class="number">158</span>, <span class="number">90</span>, <span class="number">122</span>, <span class="number">227</span>, <span class="number">21</span>, <span class="number">64</span>, <span class="number">148</span>, <span class="number">71</span>, <span class="number">222</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">145</span>, <span class="number">102</span>, <span class="number">183</span>, <span class="number">205</span>, <span class="number">34</span>, <span class="number">100</span>, <span class="number">245</span>, <span class="number">165</span>, <span class="number">156</span>, <span class="number">104</span>, <span class="number">165</span>, <span class="number">82</span>, <span class="number">134</span>, <span class="number">189</span>, <span class="number">176</span>, <span class="number">221</span>, <span class="number">118</span>, <span class="number">40</span>, <span class="number">171</span>, <span class="number">22</span>, <span class="number">149</span>, <span class="number">197</span>, <span class="number">38</span>, <span class="number">44</span>, <span class="number">246</span>, <span class="number">57</span>, <span class="number">190</span>, <span class="number">0</span>, <span class="number">165</span>, <span class="number">173</span>, <span class="number">227</span>, <span class="number">147</span>, <span class="number">158</span>, <span class="number">227</span>, <span class="number">5</span>, <span class="number">160</span>, <span class="number">176</span>, <span class="number">29</span>, <span class="number">176</span>, <span class="number">22</span>, <span class="number">11</span>, <span class="number">91</span>, <span class="number">51</span>, <span class="number">149</span>, <span class="number">164</span>, <span class="number">9</span>, <span class="number">22</span>, <span class="number">135</span>, <span class="number">86</span>, <span class="number">31</span>, <span class="number">131</span>, <span class="number">78</span>, <span class="number">74</span>, <span class="number">60</span>, <span class="number">85</span>, <span class="number">54</span>, <span class="number">111</span>, <span class="number">187</span>, <span class="number">76</span>, <span class="number">75</span>, <span class="number">157</span>, <span class="number">177</span>, <span class="number">174</span>, <span class="number">229</span>, <span class="number">142</span>, <span class="number">200</span>, <span class="number">251</span>, <span class="number">14</span>, <span class="number">41</span>, <span class="number">138</span>, <span class="number">187</span>, <span class="number">252</span>, <span class="number">32</span>, <span class="number">98</span>, <span class="number">4</span>, <span class="number">45</span>, <span class="number">128</span>, <span class="number">97</span>, <span class="number">214</span>, <span class="number">193</span>, <span class="number">204</span>, <span class="number">59</span>, <span class="number">137</span>, <span class="number">197</span>, <span class="number">139</span>, <span class="number">213</span>, <span class="number">38</span>, <span class="number">88</span>, <span class="number">214</span>, <span class="number">182</span>, <span class="number">160</span>, <span class="number">80</span>, <span class="number">117</span>, <span class="number">171</span>, <span class="number">23</span>, <span class="number">131</span>, <span class="number">127</span>, <span class="number">55</span>, <span class="number">43</span>, <span class="number">160</span>, <span class="number">29</span>, <span class="number">44</span>, <span class="number">207</span>, <span class="number">199</span>, <span class="number">224</span>, <span class="number">229</span>, <span class="number">73</span>, <span class="number">201</span>, <span class="number">250</span>, <span class="number">107</span>, <span class="number">192</span>, <span class="number">152</span>, <span class="number">102</span>, <span class="number">153</span>, <span class="number">146</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">212</span>, <span class="number">117</span>, <span class="number">70</span>, <span class="number">34</span>, <span class="number">5</span>, <span class="number">53</span>, <span class="number">209</span>, <span class="number">75</span>, <span class="number">197</span>, <span class="number">173</span>, <span class="number">224</span>, <span class="number">142</span>, <span class="number">69</span>, <span class="number">59</span>, <span class="number">80</span>, <span class="number">21</span>, <span class="number">181</span>, <span class="number">46</span>, <span class="number">133</span>, <span class="number">48</span>, <span class="number">137</span>, <span class="number">84</span>, <span class="number">18</span>, <span class="number">222</span>, <span class="number">241</span>, <span class="number">90</span>, <span class="number">240</span>, <span class="number">43</span>, <span class="number">167</span>, <span class="number">27</span>, <span class="number">74</span>, <span class="number">38</span>, <span class="number">93</span>, <span class="number">152</span>, <span class="number">212</span>, <span class="number">161</span>, <span class="number">190</span>, <span class="number">209</span>, <span class="number">77</span>, <span class="number">126</span>, <span class="number">56</span>, <span class="number">222</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">84</span>, <span class="number">184</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">173</span>, <span class="number">140</span>, <span class="number">30</span>, <span class="number">217</span>, <span class="number">49</span>, <span class="number">95</span>, <span class="number">86</span>, <span class="number">126</span>, <span class="number">189</span>, <span class="number">72</span>, <span class="number">50</span>, <span class="number">152</span>, <span class="number">46</span>, <span class="number">62</span>, <span class="number">235</span>, <span class="number">162</span>, <span class="number">29</span>]</span><br><span class="line">key = <span class="number">0x19</span></span><br><span class="line">index = <span class="number">0</span></span><br><span class="line">lst = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">  index = (<span class="number">0x7f</span> * index + <span class="number">0x66</span>) % <span class="number">0xff</span></span><br><span class="line">  <span class="keyword">if</span> index &gt;&gt; <span class="number">7</span> == <span class="number">0</span>:</span><br><span class="line">    key = (<span class="number">97</span> * key + <span class="number">101</span>) % <span class="number">233</span></span><br><span class="line">    key ^= <span class="number">0x29</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="built_in">chr</span>(enc[i] ^ box[key]), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<h1 id="tsctf-j2023-the_magic">TSCTF-J2023 The_Magic</h1>
<p>这道题需要一些TLS知识，这里不细说，感兴趣的可以自己去了解了解
TlsCallback_0函数只是一个简单的获取输入的函数：</p>
<figure>
<img src="/images/TSSEH1.png" alt="The_Magic" />
<figcaption aria-hidden="true">The_Magic</figcaption>
</figure>
<p>TlsCallback_1函数可以看到真正的加密逻辑，但是如果你按照这个逻辑来写脚本，最终还是一串乱码，。。。</p>
<figure>
<img src="/images/TSSEH2.png" alt="The_Magic" />
<figcaption aria-hidden="true">The_Magic</figcaption>
</figure>
<p>和上一道题的逻辑类似，动调出异常，汇编查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FF795001860 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00007FF795001860</span><br><span class="line">.text:00007FF795001860 loc_7FF795001860:                       ; CODE XREF: TlsCallback_1:loc_7FF79500193C↓j</span><br><span class="line">.text:00007FF795001860 mov     eax, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF795001864 inc     eax</span><br><span class="line">.text:00007FF795001866 mov     [rsp+168h+var_148], eax</span><br><span class="line">.text:00007FF79500186A</span><br><span class="line">.text:00007FF79500186A loc_7FF79500186A:                       ; CODE XREF: TlsCallback_1+23E↑j</span><br><span class="line">.text:00007FF79500186A cmp     [rsp+168h+var_148], 20h ; &#x27; &#x27;</span><br><span class="line">.text:00007FF79500186F jg      loc_7FF795001941</span><br><span class="line">.text:00007FF795001875 movsxd  rax, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF79500187A lea     rcx, input</span><br><span class="line">.text:00007FF795001881 movzx   eax, byte ptr [rcx+rax]</span><br><span class="line">.text:00007FF795001885 add     eax, 208h</span><br><span class="line">.text:00007FF79500188A movsxd  rcx, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF79500188F lea     rdx, input</span><br><span class="line">.text:00007FF795001896 mov     [rdx+rcx], al</span><br><span class="line">.text:00007FF795001899 movsxd  rax, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF79500189E mov     [rsp+168h+var_118], rax</span><br><span class="line">.text:00007FF7950018A3 lea     rcx, input</span><br><span class="line">.text:00007FF7950018AA mov     [rsp+168h+var_120], rcx</span><br><span class="line">.text:00007FF7950018AF call    rand</span><br><span class="line">.text:00007FF7950018B4 add     eax, 3E4h</span><br><span class="line">.text:00007FF7950018B9 mov     rcx, [rsp+168h+var_120]</span><br><span class="line">.text:00007FF7950018BE mov     rdx, [rsp+168h+var_118]</span><br><span class="line">.text:00007FF7950018C3 movzx   ecx, byte ptr [rcx+rdx]</span><br><span class="line">.text:00007FF7950018C7 xor     ecx, eax</span><br><span class="line">.text:00007FF7950018C9 mov     eax, ecx</span><br><span class="line">.text:00007FF7950018CB movsxd  rcx, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF7950018D0 lea     rdx, input</span><br><span class="line">.text:00007FF7950018D7 mov     [rdx+rcx], al</span><br><span class="line">.text:00007FF7950018DA</span><br><span class="line">.text:00007FF7950018DA loc_7FF7950018DA:                       ; DATA XREF: .rdata:00007FF795003950↓o</span><br><span class="line">.text:00007FF7950018DA ;   __try &#123; // __except at loc_7FF795001903</span><br><span class="line">.text:00007FF7950018DA movsxd  rax, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF7950018DF lea     rcx, input</span><br><span class="line">.text:00007FF7950018E6 movzx   eax, byte ptr [rcx+rax]</span><br><span class="line">.text:00007FF7950018EA sar     eax, 7</span><br><span class="line">.text:00007FF7950018ED mov     [rsp+168h+var_130], eax</span><br><span class="line">.text:00007FF7950018F1 mov     eax, 1</span><br><span class="line">.text:00007FF7950018F6 cdq</span><br><span class="line">.text:00007FF7950018F7 mov     ecx, [rsp+168h+var_130]</span><br><span class="line">.text:00007FF7950018FB idiv    ecx</span><br><span class="line">.text:00007FF7950018FD mov     [rsp+168h+var_128], eax</span><br><span class="line">.text:00007FF795001901 jmp     short loc_7FF79500193C</span><br><span class="line">.text:00007FF795001901 ;   &#125; // starts at 7FF7950018DA</span><br><span class="line">.text:00007FF795001903 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00007FF795001903</span><br><span class="line">.text:00007FF795001903 loc_7FF795001903:                       ; DATA XREF: .rdata:00007FF795003950↓o</span><br><span class="line">.text:00007FF795001903 ;   __except(loc_7FF795002CE0) // owned by 7FF7950018DA</span><br><span class="line">.text:00007FF795001903 movsxd  rax, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF795001908 lea     rcx, input</span><br><span class="line">.text:00007FF79500190F movzx   eax, byte ptr [rcx+rax]</span><br><span class="line">.text:00007FF795001913 add     eax, 7Bh ; &#x27;&#123;&#x27;</span><br><span class="line">.text:00007FF795001916 movsxd  rcx, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF79500191B lea     rdx, unk_7FF7950051E0</span><br><span class="line">.text:00007FF795001922 mov     ecx, [rdx+rcx*4]</span><br><span class="line">.text:00007FF795001925 sub     ecx, 1C8h</span><br><span class="line">.text:00007FF79500192B xor     eax, ecx</span><br><span class="line">.text:00007FF79500192D movsxd  rcx, [rsp+168h+var_148]</span><br><span class="line">.text:00007FF795001932 lea     rdx, input</span><br><span class="line">.text:00007FF795001939 mov     [rdx+rcx], al</span><br><span class="line">.text:00007FF79500193C</span><br><span class="line">.text:00007FF79500193C loc_7FF79500193C:                       ; CODE XREF: TlsCallback_1+2E1↑j</span><br><span class="line">.text:00007FF79500193C jmp     loc_7FF795001860</span><br></pre></td></tr></table></figure>
<p>啊！<sub>如此美妙的汇编</sub>~
首先看，__try块中产生的整数除零异常，和上一题不能说十分相似，只能说一模一样
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FF7950018EA sar     eax, 7</span><br><span class="line">.text:00007FF7950018ED mov     [rsp+168h+var_130], eax</span><br><span class="line">.text:00007FF7950018F1 mov     eax, 1</span><br><span class="line">.text:00007FF7950018F6 cdq</span><br><span class="line">.text:00007FF7950018F7 mov     ecx, [rsp+168h+var_130]</span><br><span class="line">.text:00007FF7950018FB idiv    ecx</span><br></pre></td></tr></table></figure> 这个加密循环的汇编也不是很难理解？？~或许吧，。
好的，不多说，默认大家是可以看懂汇编的~，因为SEH部分分析完了嘻嘻
按照这个汇编逻辑我们可以写出解密代码： <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> Seed = <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getrand</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Seed = (Seed + <span class="number">1029</span>) * <span class="number">3847</span> % <span class="number">5665</span>;</span><br><span class="line">    <span class="keyword">return</span> Seed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> enc[<span class="number">100</span>] = &#123; <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="number">111</span>, <span class="number">186</span>, <span class="number">117</span>, <span class="number">71</span>, <span class="number">44</span>, <span class="number">54</span>, <span class="number">93</span>, <span class="number">43</span>, <span class="number">179</span>, <span class="number">68</span>, <span class="number">158</span>, <span class="number">25</span>, <span class="number">145</span>, <span class="number">107</span>, <span class="number">229</span>, <span class="number">146</span>, <span class="number">220</span>, <span class="number">128</span>, <span class="number">220</span>, <span class="number">203</span>, <span class="number">195</span>, <span class="number">73</span>, <span class="number">179</span>, <span class="number">12</span>, <span class="number">7</span>, <span class="string">&#x27;&#125;&#x27;</span> &#125;;</span><br><span class="line">    <span class="type">int</span> Xor[<span class="number">100</span>] = &#123; <span class="number">611</span>, <span class="number">613</span>, <span class="number">709</span>, <span class="number">611</span>, <span class="number">591</span>, <span class="number">589</span>, <span class="number">599</span>, <span class="number">597</span>, <span class="number">4732</span>, <span class="number">2686</span>, <span class="number">1877</span>, <span class="number">2929</span>, <span class="number">2678</span>, <span class="number">7275</span>, <span class="number">5979</span>, <span class="number">3657</span>, <span class="number">3879</span>, <span class="number">8962</span>, <span class="number">7445</span>, <span class="number">2694</span>, <span class="number">3384</span>, <span class="number">3710</span>, <span class="number">4938</span>, <span class="number">2832</span>, <span class="number">2329</span>, <span class="number">4215</span>, <span class="number">3152</span>, <span class="number">4911</span>, <span class="number">6525</span>, <span class="number">3445</span>, <span class="number">2071</span>, <span class="number">5765</span>, <span class="number">3700</span>, <span class="number">3156</span>, <span class="number">4178</span>, <span class="number">7234</span>, <span class="number">3437</span>, <span class="number">2437</span>, <span class="number">5236</span>, <span class="number">7265</span>, <span class="number">5391</span>, <span class="number">6257</span>, <span class="number">5756</span>, <span class="number">3426</span>, <span class="number">3446</span>, <span class="number">7432</span>, <span class="number">3871</span>, <span class="number">3442</span>, <span class="number">2200</span>, <span class="number">589</span> &#125;;</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;TSCTF-J&#123;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">8</span>; i &lt;= <span class="number">32</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> randint = <span class="built_in">getrand</span>();</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">32</span>; j &lt; <span class="number">126</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> input = j;</span><br><span class="line">            input = (<span class="type">unsigned</span> <span class="type">char</span>)((input + <span class="number">520</span>) ^ (randint + <span class="number">996</span>));</span><br><span class="line">            <span class="keyword">if</span>(input &gt;&gt; <span class="number">7</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                input = (<span class="type">unsigned</span> <span class="type">char</span>)((input + <span class="number">123</span>) ^ (Xor[i] - <span class="number">456</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(input == enc[i])</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="built_in">char</span>(j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> #
小插曲，SEH深入分析 ### SEH链
SEH以链的形式存在。第一个异常处理中未处理相关异常，它就会被传递到下一个异常处理器，直到得到处理。
SEH链是由_EXCEPTION_REGISTRATION_RECORD结构体组成的链表，
**_EXCEPTION_REGISTRATION_RECORD结构体定义如下<strong> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Next</span>;</span></span><br><span class="line">    <span class="comment">//指向下一个 EXCEPTION_REGISTRATION_RECORD</span></span><br><span class="line"></span><br><span class="line">    PEXCEPTION_DISPOSITION Handler;  </span><br><span class="line">    <span class="comment">//指向异常处理函数</span></span><br><span class="line">&#125; EXCEPTION_REGISTRATION_RECORD,*PEXCEPTION_REGISTRATION_RECORD;</span><br></pre></td></tr></table></figure> ###
异常处理函数 </strong>异常处理函数定义如下<strong> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_DISPOSITION __cdecl _except_handler</span><br><span class="line">(</span><br><span class="line">  EXCEPTION_RECORD              *pRecord,</span><br><span class="line">  EXCEPTION_REGISTRATION_RECORD *pFrame,</span><br><span class="line">  CONTEXT                       *pContext,</span><br><span class="line">  PVOID                          pValue</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
异常处理函数接受4个参数输入，这4个参数保存着一些与异常相关的信息。
第2个参数EXCEPTION_REGISTRATION_RECORD即是上文提到过的SEH链结构体，第4个参数是OS保留，可以忽略，下面会分析第1和第3个参数。
异常处理函数返回名为EXCEPTION_DISPOSITION的枚举类型，它由系统调用，是一个回调函数。
</strong>EXCEPTION_RECORD结构体定义<strong> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> &#123;</span></span><br><span class="line">    DWORD ExceptionCode;        <span class="comment">// 异常代码（如 0xC0000005 表示访问冲突）</span></span><br><span class="line">    DWORD ExceptionFlags;       <span class="comment">// 异常标志（如 0 表示异常是第一次发生）</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span>* <span class="title">ExceptionRecord</span>;</span> <span class="comment">// 链接下一个异常记录</span></span><br><span class="line">    PVOID ExceptionAddress;     <span class="comment">// 触发异常的地址</span></span><br><span class="line">    DWORD NumberParameters;     <span class="comment">// 附加信息的参数数量</span></span><br><span class="line">    ULONG_PTR ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS]; <span class="comment">// 附加参数</span></span><br><span class="line">&#125; EXCEPTION_RECORD, *PEXCEPTION_RECORD;</span><br></pre></td></tr></table></figure>
ExceptionCode指出异常类型，即上文提到过的一些对应的异常值。
ExceptionAddress表示发生异常的代码地址
</strong>CONTEXT结构体定义<strong>
异常处理函数接受的第三个参数是指向CONTEXT结构体的指针，它用来备份CPU的值。
多线程环境下，每个线程内部都有一个CONTEXT结构体。
CPU离开当前线程转而运行其他线程时，CPU寄存器的值被保存到当前线程的CONTEXT结构体中，当CPU返回该线程时，使用保存在CONTEXT结构体中的值来覆盖CPU各寄存器的值，以此来保证多线程安全。
CONTEXT结构体的定义如下： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _CONTEXT &#123;</span><br><span class="line">    DWORD ContextFlags;</span><br><span class="line">    DWORD   Dr0;                //0x04</span><br><span class="line">    DWORD   Dr1;                //0x08</span><br><span class="line">    DWORD   Dr2;                //0x0c</span><br><span class="line">    DWORD   Dr3;                //0x10</span><br><span class="line">    DWORD   Dr6;                //0x14</span><br><span class="line">    DWORD   Dr7;                //0x18</span><br><span class="line"></span><br><span class="line">    FLOATING_SAVE_AREA FloatSave;</span><br><span class="line"></span><br><span class="line">    DWORD   SegGs;              //0x88</span><br><span class="line">    DWORD   SegFs;              //0x90</span><br><span class="line">    DWORD   SegEs;              //0x94</span><br><span class="line">    DWORD   SegDs;              //0x98</span><br><span class="line"></span><br><span class="line">    DWORD   Edi;                //0x9c</span><br><span class="line">    DWORD   Esi;                //0xa0</span><br><span class="line">    DWORD   Ebx;                //0xa4</span><br><span class="line">    DWORD   Edx;                //0xa8</span><br><span class="line">    DWORD   Ecx;                //0xac</span><br><span class="line">    DWORD   Eax;                //0xb0</span><br><span class="line">    DWORD   Ebp;                //0xb4</span><br><span class="line">    DWORD   Eip;                //0xb8</span><br><span class="line"></span><br><span class="line">    DWORD   SegCs;              //0xbc MUST BE SANITIZED</span><br><span class="line">    DWORD   EFlags;             //0xc0 MUST BE SANITIZED</span><br><span class="line">    DWORD   Esp;                //0xc4</span><br><span class="line">    DWORD   SegSs;              //0xc8</span><br><span class="line"></span><br><span class="line">    BYTE    ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];</span><br><span class="line">&#125; CONTEXT;</span><br></pre></td></tr></table></figure> 一部分，具体请看微软文档
下面着重看一下Eip的值：
一般来讲Eip成员应该存储触发异常后的代码地址，即触发异常时的Eip值。
具体而言，当某一句代码触发异常，那么Eip的值应该指向这句代码的结束地址。这样当SEH处理完毕异常后，程序可以回到原来的地方，继续执行正常的代码。
但是，
<strong>在异常处理函数中可能将参数传递过来的CONTEXT.Eip设置为其他地址，然后返回处理函数。
这样之前暂停的线程会执行新的EIP地址处的代码（反调试中经常使用这个技术）。</strong>
</strong>返回值 EXCEPTION_DISPOSITION定义** typedef enum
_EXCEPTION_DISPOSITION { ExceptionContinueExecution = 0,
//已经处理了异常，回到异常触发点继续执行 ExceptionContinueSearch = 1,
//没有处理异常，继续遍历异常链表 ExceptionNestedException = 2,
//OS内部使用 ExceptionCollidedUnwind = 3 //OS内部使用
}EXCEPTION_DISPOSITION; ### SEH内部函数 结构化异常处理提供了两个可用于
try-except 语句的内部函数： GetExceptionCode 返回 (一个32位整数)
的代码，也就是上文提到过的异常原因相对应的异常值。
GetExceptionInformation 返回一个指向 EXCEPTION_POINTERS
结构的指针，该结构包含有关异常的其他信息。
<strong>EXCEPTION_POINTERS定义</strong> EXCEPTION_POINTERS 是 Windows
平台上一个常见的数据结构，用于描述异常发生时的上下文。它包含异常记录和线程上下文的信息，定义如下：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_POINTERS</span> &#123;</span></span><br><span class="line">    PEXCEPTION_RECORD ExceptionRecord;</span><br><span class="line">    PCONTEXT ContextRecord;</span><br><span class="line">&#125; EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;</span><br></pre></td></tr></table></figure> ExceptionRecord上文已经介绍过了</p>
<p>ContextRecord： 类型：PCONTEXT （指向 CONTEXT 结构的指针）
描述：保存异常发生时的线程上下文，包括寄存器值、堆栈指针、程序计数器等。
常用字段： Eip/Rip（指令指针，用于 x86/x64 架构） Esp/Rsp（栈指针）
Ebp/Rbp（基址指针） 寄存器状态（如 Eax, Ebx 等） 下面我们来看一道题： #
miniL2021 0oooop</p>
<figure>
<img src="/images/OPSEH1.png" alt="0oooop" />
<figcaption aria-hidden="true">0oooop</figcaption>
</figure>
<p>进入一看，内存访问错误~，真是友好的粗体人
我们打开汇编一看，又是SEH，</p>
<figure>
<img src="/images/OPSEH2.png" alt="0oooop" />
<figcaption aria-hidden="true">0oooop</figcaption>
</figure>
<p>这里__except(loc_6F2356)的意思就是跳转到指定的处理代码块（
loc_6F2356）。
类似与刚开始示例中exception_memory_access_violation函数的位置
跟进loc_412356的__except
filter，然后跟进sub_411131，此函数经过一次跳转到sub_411DD0。反编译结果如下：</p>
<figure>
<img src="/images/OPSEH3.png" alt="0oooop" />
<figcaption aria-hidden="true">0oooop</figcaption>
</figure>
<p>看到a2是一个很奇怪的数，我们对他进行M去转成枚举类型，可以知道a2就是EXCEPTION_INT_DIVIDE_BY_ZERO，即整数除0异常。
继续注意，可以看到这个加密在对a2进行异或加减的时候，里面有一个操作*(_DWORD
*)(a2 + 4) + 184，
由于184的16进制是0xb8,对照上面写的CONTEXT结构体后面的注释，可以知道这个就是Eip的值,即触发异常代码的下一句代码的地址值，取它的最后一字节来异或。
返回去看__try块， <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:006F2330 ;   __try &#123; // __except at loc_6F2377</span><br><span class="line">.text:006F2330                 mov     [ebp+ms_exc.registration.TryLevel], 0</span><br><span class="line">.text:006F2337                 lea     ebx, [ebp+Str]</span><br><span class="line">.text:006F233D                 xor     eax, eax</span><br><span class="line">.text:006F233F                 db      3Eh</span><br><span class="line">.text:006F233F                 mov     dword ptr [eax], 0</span><br><span class="line">.text:006F2346                 mov     edx, 0</span><br><span class="line">.text:006F234B                 div     edx</span><br><span class="line">.text:006F234B ;   &#125; // starts at 6F2330</span><br></pre></td></tr></table></figure> 下面两句是整数除0异常触发代码，
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:006F2346                 mov     edx, 0</span><br><span class="line">.text:006F234B                 div     edx</span><br></pre></td></tr></table></figure> try块结束地址是.text:006F234B，所以这个数就是0x4B。</p>
<p>后面的几句代码跳转也可以说明这个就是EIP的值 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>：</span><br><span class="line">      *(_DWORD *)(*(_DWORD *)(a2 + <span class="number">4</span>) + <span class="number">184</span>) += <span class="number">54</span>;</span><br><span class="line"><span class="keyword">else</span>：</span><br><span class="line">  *(_DWORD *)(*(_DWORD *)(a2 + <span class="number">4</span>) + <span class="number">184</span>) += <span class="number">63</span>;</span><br></pre></td></tr></table></figure>
也是在CONTEXT结构体那里强调过，可以通过修改CONTEXT的Eip来控制程序返回的地址。
我们有理由相信这两个操作是为了转向不同的结果：即为我们打印失败或成功的信息。所以这里应当修改的是Eip的值，也就是控制程序返回不同的地址。</p>
<p>好，但是这样做很麻烦，我们可以借助ida来帮我们分析， if ( **(_DWORD
<strong>)a2 != EXCEPTION_INT_DIVIDE_BY_ZERO )，
我们已经知道</strong>(_DWORD **)a2是_EXCEPTION_RECORD
里面的ExceptionCode;
上文提及过，结构化异常处理内部函数只有GetExceptionCode和GetExceptionInformation。
代码中对a2解引用两次才得到ExceptionCode，所以我们可以推知代码访问使用的函数应该是GetExceptionInformation，而a2则是此函数的返回值类型。
具体而言，站在异常的角度来看，a2的数据类型应该是_EXCEPTION_POINTERS
*类型的。 修改a2的类型之后，一切都变得如此明了~~~</p>
<figure>
<img src="/images/OPSEH4.png" alt="0oooop" />
<figcaption aria-hidden="true">0oooop</figcaption>
</figure>
<p>当然还有内存访问异常，在TLS里面，这个涉及另一种机制VEH，由于不是本文重点，就不说了
<sub>我是不会承认是因为我太菜了不会的，呜呜</sub></p>
<h1 id="一点小细节">一点小细节</h1>
<p>我之前说__except块中的代码（也就是异常处理程序except
handler）中的内容是不能被IDA反编译出来的。
但在miniL这道题中，我们是看反编译出来的结果，为什么会这样？
来看一下__except 的内容：</p>
<p>__except ( /<em>异常过滤器exception filter</em>/ ) { //
异常处理程序exception handler }</p>
<p>注意__except块中有两个重要的成员： 异常过滤器exception filter
异常处理程序exception handler moectf以及TSCTF都将核心代码写入exception
handler，也就是__except块大括号包裹的内容，这里的东西是不能够被IDA反编译出来的，所以我们只能通过阅读汇编获得程序逻辑。
而miniL的题目则是将核心代码写入exception
filter。由于异常过滤器实际上也是一个函数，所以能够被IDA识别并且反编译。</p>
<p>简而言之，如果出题人想考验选手阅读汇编代码的能力，那么就将代码直接写在exception
handler中。 如果出题人不想为难选手嗯怼汇编，就把代码写入exception
filter函数中，或者在exception
handler中调用一个写入核心加密过程的函数。</p>
<h1 id="鹏城杯-re5">2024鹏城杯 RE5</h1>
<p>点进去，一个人畜无害的TEA加密，但是你这样解密之后，仍旧是一串乱码，hhhhhh
当然，你粗略的看一遍汇编就知道这也是个SEH</p>
<figure>
<img src="/images/RE5SEH.png" alt="RE5" />
<figcaption aria-hidden="true">RE5</figcaption>
</figure>
<p>当然，TEA里面也有一个类似的异常处理
main函数处理的是整数除0异常，TEA里面有一个整数除0异常，循环里面有内存访问异常</p>
<figure>
<img src="/images/RE5SEH2.png" alt="RE5" />
<figcaption aria-hidden="true">RE5</figcaption>
</figure>
<p>可以看到， 分支 1: EXCEPTION_ACCESS_VIOLATION
访问冲突异常（EXCEPTION_ACCESS_VIOLATION），通常是非法访问内存（如读写空指针）。</p>
<p>处理： 计算堆栈上的某个地址（Esp + 96），并将一个随机数存储到该地址。
修改 EIP（指令指针）以跳过异常触发的指令（增加
2），让程序继续执行而不会反复触发异常。 返回 -1，表示异常已被处理。</p>
<p>分支 2: EXCEPTION_INT_DIVIDE_BY_ZERO
整数除零异常（EXCEPTION_INT_DIVIDE_BY_ZERO），通常是尝试除以零。</p>
<p>处理： 使用 srand(0) 重置随机数生成器的种子为 0。 调用 sub_401000()，
注册了一个名为 Handler
的自定义向量化异常处理程序，并返回注册成功后的句柄。
修改堆栈上的某个值（Esp + 84）为 2。 修改
EIP（指令指针）以跳过异常触发的指令（增加 2），避免循环触发。 返回
-1，表示异常已被处理。 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LONG __stdcall Handler(struct _EXCEPTION_POINTERS *ExceptionInfo)</span><br><span class="line">&#123;</span><br><span class="line">  if ( ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode != EXCEPTION_INT_DIVIDE_BY_ZERO )</span><br><span class="line">    return 0;</span><br><span class="line">  *(_DWORD *)(ExceptionInfo-&gt;ContextRecord-&gt;Esp + 80) = 3;</span><br><span class="line">  ExceptionInfo-&gt;ContextRecord-&gt;Eip += 2;</span><br><span class="line">  return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 和分支1的处理类似</p>
<p>这样一步步的调试，跟踪地址，我们可以发现这个TEA原本的样貌（具体分析自己去动调跟一下吧，我觉得我说的很清楚了）：
key[]被改成了{2, 2, 3, 3}; sum -= 1640531527; 被改成了： sum +=
rand();其中srand = 0 下面就可以写脚本了： <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decrypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span>* data, <span class="type">unsigned</span> <span class="type">int</span>* key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> v0 = data[<span class="number">0</span>], v1 = data[<span class="number">1</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> roundsum[<span class="number">32</span>],sum;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> round = <span class="number">0</span>; round &lt; <span class="number">32</span>; round++)</span><br><span class="line">	&#123;</span><br><span class="line">		roundsum[round] = <span class="built_in">rand</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (round &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			roundsum[round] += roundsum[round - <span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		sum = roundsum[<span class="number">31</span> - i];</span><br><span class="line">		v1 -= (key[<span class="number">3</span>] + (v0 &gt;&gt; <span class="number">5</span>)) ^ (sum + v0) ^ (key[<span class="number">2</span>] + <span class="number">16</span> * v0);</span><br><span class="line">		v0 -= (key[<span class="number">1</span>] + (v1 &gt;&gt; <span class="number">5</span>)) ^ (sum + v1) ^ (*key + <span class="number">16</span> * v1);</span><br><span class="line">	&#125;</span><br><span class="line">	data[<span class="number">0</span>] = v0;</span><br><span class="line">	data[<span class="number">1</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">srand</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> sum = <span class="number">0</span>, delta = <span class="number">1640531527</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>  key[<span class="number">5</span>] = &#123; <span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span> &#125;;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> enc[] = &#123; </span><br><span class="line">        <span class="number">0xEA2063F8</span>, <span class="number">0x8F66F252</span>,</span><br><span class="line">		<span class="number">0x902A72EF</span>, <span class="number">0x411FDA74</span>,</span><br><span class="line">		<span class="number">0x19590D4D</span>, <span class="number">0xCAE74317</span>,</span><br><span class="line">		<span class="number">0x63870F3F</span>, <span class="number">0xD753AE61</span></span><br><span class="line">        &#125;;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">decrypt</span>(&amp;enc[i * <span class="number">2</span>], key);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n%s&quot;</span>, (<span class="type">char</span> *)enc);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="另一个小插曲teb">另一个小插曲：TEB</h1>
<p>下面要介绍VC++编译器对SEH所做的增强版本，在这之前，先说明一些关于TEB（Thread
Environment Block，线程环境块）的知识。在这里只讲解与SEH相关的内容。
TEB成员众多，此处我们只需要了解_NT_TIB。 SEH 机制依赖其中的 _NT_TIB
结构，_NT_TIB 中的 ExceptionList 字段是异常处理链的起点。
**_NT_TIB结构** <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">ExceptionList</span>;</span></span><br><span class="line">    PVOID StackBase;</span><br><span class="line">    PVOID StackLimit;</span><br><span class="line">    PVOID SubSystemTib;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        PVOID FiberData;</span><br><span class="line">        DWORD Version;</span><br><span class="line">    &#125;;</span><br><span class="line">    PVOID ArbitraryUserPointer;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> *<span class="title">Self</span>;</span></span><br><span class="line">&#125; NT_TIB;</span><br></pre></td></tr></table></figure></p>
<p>ExceptionList:指向 _EXCEPTION_REGISTRATION_RECORD
结构的链表头，表示当前线程的 SEH 链。 StackBase 和
StackLimit:定义了当前线程的栈边界。
Self:指向自身的指针，用于访问当前线程的 TEB。</p>
<p><strong>TEB访问方法</strong> Ntdll.NtCurrentTeb()
用户模式下使用此函数访问TEB，Ntdll.NtCurrentTeb()返回当前线程的TEB结构体的地址。</p>
<p>FS段寄存器 FS:[0]指向SEH起始地址。</p>
<p>我们知道，原始的 SEH 机制通过 _EXCEPTION_REGISTRATION_RECORD
链表实现，每个注册的异常处理器都会挂载到这个链表上。 而VC++ 编译器增强的
SEH 机制在 _EXCEPTION_REGISTRATION
结构中添加了额外字段，用于支持更复杂的异常处理功能。
**_EXCEPTION_REGISTRATION** <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION</span> *<span class="title">prev</span>;</span>       <span class="comment">// 指向上一个异常记录</span></span><br><span class="line">    <span class="type">void</span> *handler;                              <span class="comment">// 异常处理函数指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scopetable_entry</span> *<span class="title">scopetable</span>;</span>        <span class="comment">// 指向 scopetable 的数组</span></span><br><span class="line">    <span class="type">int</span> trylevel;                               <span class="comment">// 当前 try 块的索引</span></span><br><span class="line">    <span class="type">int</span> _ebp;                                   <span class="comment">// 栈帧指针</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>新增功能： scopetable:一个数组，存储所有 __try
块的过滤函数（filter）和终止函数（handler）。 每个 __try
块对应一个数组元素。 trylevel:当前处于第几个 __try 块。
_ebp:保存当前栈帧，用于返回到函数上下文。</p>
<p><strong>SCOPETABLE</strong> SCOPETABLE 是一个辅助结构，用于管理多个
__try 块的处理逻辑。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SCOPETABLE</span> &#123;</span></span><br><span class="line">    DWORD previousTryLevel;   <span class="comment">// 前一个 try 块的索引</span></span><br><span class="line">    DWORD lpfnFilter;         <span class="comment">// 当前 try 块的过滤函数 (__except 的条件表达式)</span></span><br><span class="line">    DWORD lpfnHandler;        <span class="comment">// 当前 try 块的终止函数 (__finally 块的逻辑）</span></span><br><span class="line">&#125; SCOPETABLE, *PSCOPETABLE;</span><br></pre></td></tr></table></figure></p>
<p>所以， 按照原始的设计，每一个__try/__except(__finally) 都应该对应一个
EXCEPTION_REGISTRATION。 但是VS实际实现中，每个使用
__try/__except(__finally) 的函数，不管其内部嵌套或反复使用多少
__try/__except(__finally)，都只注册一遍，即只将一个
EXCEPTION_REGISTRATION 挂入当前线程的异常链表中。 MSC（Microsoft Visual
C++ 编译器） 提供一个处理函数，即 EXCEPTION_REGISTRATION::handler
被设置为 MSC 的某个函数，而不是我们自己提供的 __except
代码块，我们自己提供的多个 __except 块被存储在
EXCEPTION_REGISTRATION::scopetable 数组中。 下面看个题来理解一下： #
SCTF2019 creakme</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zz-906.github.io/">fine</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://zz-906.github.io/2024/11/16/SHE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">http://zz-906.github.io/2024/11/16/SHE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://zz-906.github.io" target="_blank">fineのblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RE/">RE</a></div><div class="post-share"><div class="social-share" data-image="/img/02.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2025/02/02/REVM/" title="REVM"><img class="cover" src="/img/02.png" onerror="onerror=null;src='/img/03.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">REVM</div></div></a><a class="next-post pull-right" href="/2024/11/03/pwn-%E6%B5%85%E5%AD%A6%E4%B8%80%E4%B8%8B/" title="pwn_浅学一下"><img class="cover" src="/img/02.png" onerror="onerror=null;src='/img/03.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">pwn_浅学一下</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/2024/10/25/0xGameweek1-3wp/" title="0xGameweek_WP"><img class="cover" src="/img/02.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="title">0xGameweek_WP</div></div></a><a href="/2024/11/02/Andirod-Lua-BasicLearing/" title="Andirod_Lua_BasicLearing"><img class="cover" src="/img/02.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-02</div><div class="title">Andirod_Lua_BasicLearing</div></div></a><a href="/2024/10/07/NewStarCTF-FirstWeek/" title="NewStarCTF-FirstWeek"><img class="cover" src="/img/02.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-07</div><div class="title">NewStarCTF-FirstWeek</div></div></a><a href="/2025/05/15/PE_And_Basic_Hook/" title="PE_And_Basic_Hook"><img class="cover" src="/img/02.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-15</div><div class="title">PE_And_Basic_Hook</div></div></a><a href="/2024/10/08/SHCTF-Week1WP/" title="SHCTF-Week1WP"><img class="cover" src="/img/02.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">SHCTF-Week1WP</div></div></a><a href="/2025/03/16/cython%E5%85%A5%E9%97%A8/" title="cython入门"><img class="cover" src="/img/02.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-16</div><div class="title">cython入门</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/touxiang.jpg" onerror="this.onerror=null;this.src='/img/hutao.png'" alt="avatar"/></div><div class="author-info-name">fine</div><div class="author-info-description">北邮苦命仔一枚~</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zz-906"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/zz-906" target="_blank" title="Github"><i class="fab fa-github" style="color: #8a2be2;"></i></a><a class="social-icon" href="https://blog.csdn.net/zz__f?type=blog" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #8a2be2;"></i></a><a class="social-icon" href="mailto:2173990147@qq.com" target="_blank" title="email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><style>
.announcement-card {
    --main-color: #ff00ff;
    --secondary-color: #00ffff;
    --highlight-color: #ff5500;
    position: relative;
    overflow: hidden;
}
.announcement-content {
    font-size: 1rem; 
    line-height: 1.2; 
    color: #ffffff;
    position: relative;
}
.keyword {
    color: var(--secondary-color);
    font-weight: 300;
    font-size: 1.1rem; 
}
.highlight {
    color: var(--main-color);
    font-weight: 1000;
    font-size: 1.2rem; 
}
.announcement-content ul {
    list-style-type: none;
    margin: 0.8rem 0; 
    padding-left: 1.5rem;   
}
</style>
<div class="announcement-card">
    <div class="announcement-content">
        <p><span class="highlight">欢迎来到fine的学习研习录</span>！🎉</p>
        <p><strong>本平台专注于：</strong></p>
        <ul>
            <li><span class="keyword">> CTF竞赛复现</span></li>
            <li><span class="keyword">> AI安全研究</span></li>
        </ul>
        <p>🌟 <strong>探索网络安全奥秘，提升攻防实战能力，共同守护数字世界的安宁！</strong></p>
    </div>
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#tsctf-j2023-the_magic"><span class="toc-number">1.</span> <span class="toc-text">TSCTF-J2023 The_Magic</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E7%82%B9%E5%B0%8F%E7%BB%86%E8%8A%82"><span class="toc-number">2.</span> <span class="toc-text">一点小细节</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%B9%8F%E5%9F%8E%E6%9D%AF-re5"><span class="toc-number">3.</span> <span class="toc-text">2024鹏城杯 RE5</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%8F%92%E6%9B%B2teb"><span class="toc-number">4.</span> <span class="toc-text">另一个小插曲：TEB</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/12/AI%E6%94%BB%E5%87%BB/" title="窃取攻击"><img src="/img/yileina02.png" onerror="this.onerror=null;this.src='/img/03.png'" alt="窃取攻击"/></a><div class="content"><a class="title" href="/2025/08/12/AI%E6%94%BB%E5%87%BB/" title="窃取攻击">窃取攻击</a><time datetime="2025-08-12T07:34:00.000Z" title="发表于 2025-08-12 15:34:00">2025-08-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/07/ai%E8%B6%8A%E7%8B%B1%E6%94%BB%E5%87%BB/" title="越狱攻击"><img src="/img/huiliyi.png" onerror="this.onerror=null;this.src='/img/03.png'" alt="越狱攻击"/></a><div class="content"><a class="title" href="/2025/08/07/ai%E8%B6%8A%E7%8B%B1%E6%94%BB%E5%87%BB/" title="越狱攻击">越狱攻击</a><time datetime="2025-08-07T07:15:00.000Z" title="发表于 2025-08-07 15:15:00">2025-08-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/15/PE_And_Basic_Hook/" title="PE_And_Basic_Hook"><img src="/img/02.png" onerror="this.onerror=null;this.src='/img/03.png'" alt="PE_And_Basic_Hook"/></a><div class="content"><a class="title" href="/2025/05/15/PE_And_Basic_Hook/" title="PE_And_Basic_Hook">PE_And_Basic_Hook</a><time datetime="2025-05-15T07:46:24.000Z" title="发表于 2025-05-15 15:46:24">2025-05-15</time></div></div></div></div></div></div></main><footer id="footer" style="background-color: rgba(45, 10, 61, 0.2);"><div id="footer-wrap"><div class="footer_custom_text"><style>
  .footer {
    text-align: center;
    position: relative;
  }
  .social-links {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
  .social-links i {
    color: #8400ff;
  }
  .social-link {
    color: #8a2be2;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background: rgba(138, 43, 226, 0.1);
  }
  .social-link:hover {
    color: #892be294;
    background: #892be294;
    transform: translateY(-3px) scale(1.2);
    box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
    text-decoration: none !important; 
  }
  .footer p {
    margin: 0.5rem 0;
    line-height: 1;
  }
  .copyright {
    font-size: 1.1rem; 
    color: #c08bdf;
    font-weight: 400;
  }
  .tagline {
    font-size: 0.8rem;
    color: #8a2be2;
    font-style: italic;
    font-weight: 500;
  }
  .visitor-count {
    font-size: 0.75rem;
    color: rgba(219, 142, 255, 0.658);
    font-weight: 300;
  }
  #visitorCount {
    font-weight: bold;
  }
</style>
<div class="footer">
  <div class="social-links">
    <a href="https://github.com/zz-906" class="social-link" target="_blank" rel="noopener noreferrer" aria-label="GitHub" title="GitHub">
      <i class="fab fa-github"></i>
    </a>
    <a href="https://blog.csdn.net/zz__f?type=blog" class="social-link" target="_blank" rel="noopener noreferrer" aria-label="CSDN" title="CSDN">
      <i class="fas fa-code"></i>
    </a>
  </div>
  <p class="copyright">© 2025 fineのblog - 所有权利保留</p>
  <p class="tagline">> Stay curious, stay hacking, stay anime! <</p>
  <p class="visitor-count">访问量: <span id="visitorCount">1024</span> | 你是第 <span id="dailyVisitor">1</span> 位今日访客</p>
</div>
<script>
  // 确保DOM加载完成后执行
  document.addEventListener('DOMContentLoaded', function() {
    // 模拟访问量增长
    function updateVisitorCount() {
      const countElement = document.getElementById('visitorCount');
      let count = parseInt(countElement.textContent) || 1024;
      // 从localStorage获取或初始化计数
      const storedCount = localStorage.getItem('totalVisitors');
      if (storedCount) {
        count = parseInt(storedCount);
        countElement.textContent = count;
      }
      // 每日访客计数
      const today = new Date().toDateString();
      const dailyData = JSON.parse(localStorage.getItem('dailyVisitors') || '{"date":"", "count":0}');
      if (dailyData.date !== today) {
        dailyData.date = today;
        dailyData.count = 0;
      }
      dailyData.count += 1;
      document.getElementById('dailyVisitor').textContent = dailyData.count;
      localStorage.setItem('dailyVisitors', JSON.stringify(dailyData));
      // 每30秒随机增加访问量
      setInterval(() => {
        count += Math.floor(Math.random() * 3);
        countElement.textContent = count;
        localStorage.setItem('totalVisitors', count.toString());
      }, 30000);
    }
    updateVisitorCount();
    // 添加点击动画效果
    const socialLinks = document.querySelectorAll('.social-link');
    socialLinks.forEach(link => {
      link.addEventListener('click', function() {
        this.style.transform = 'scale(0.9)';
        setTimeout(() => {
          this.style.transform = '';
        }, 300);
      });
    });
  });
</script>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script defer src="/js/cursor.js"></script><script src="/js/sakura.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="输入关键词…" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/08/12/AI攻击/" alt=""><img width="48" height="48" src="/img/yileina02.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-12</span><a class="blog-slider__title" href="2025/08/12/AI攻击/" alt="">窃取攻击</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2025/08/12/AI攻击/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/08/07/ai越狱攻击/" alt=""><img width="48" height="48" src="/img/huiliyi.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-07</span><a class="blog-slider__title" href="2025/08/07/ai越狱攻击/" alt="">越狱攻击</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2025/08/07/ai越狱攻击/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax>
  function butterfly_categories_card_injector_config(){
    // 检查容器是否存在
    var parent_div_git = document.getElementById('recent-posts');
    // 如果容器不存在，则动态创建
    if (!parent_div_git) {
      console.warn('butterfly_categories_card: 挂载容器不存在，正在动态创建...');
      // 创建新容器（默认插入到页面主体顶部）
      parent_div_git = document.createElement('div');
      parent_div_git.id = 'recent-posts'; // 赋予配置的ID
      document.querySelector('#page').prepend(parent_div_git); // 插入到 #content-inner 内
    }
    var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 950px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 800px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(/img/11.png);"> <a class="categoryBar-list-link" href="/categories/CTF/">CTF</a><span class="categoryBar-list-count">10</span><span class="categoryBar-list-descr">1</span></li><li class="categoryBar-list-item" style="background:url(/img/12.png);"> <a class="categoryBar-list-link" href="/categories/AI/">AI</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">2</span></li><li class="categoryBar-list-item" style="background:url(/img/13.png);"> <a class="categoryBar-list-link" href="/categories/Test/">Test</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">3</span></li><li class="categoryBar-list-item" style="background:url(/img/14.png);"> <a class="categoryBar-list-link" href="/categories/Course/">Course</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">4</span></li><li class="categoryBar-list-item" style="background:url(/img/15.png);"> <a class="categoryBar-list-link" href="/categories/Life-Talk/">Life_Talk</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">5</span></li></ul></div></div>';
    console.log('已挂载 butterfly_categories_card');
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
  }
  // 路径匹配逻辑（使用 startsWith）
  if (location.pathname.startsWith('/categories/') || '/categories/' === 'all') {
    butterfly_categories_card_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>